
trigger:
- master

variables:
  - group: MyVarGroup
  - name: rgname
    value: rg-for-tests
  - name: location
    value: westeurope
  - name: clustername
    value: myaks1
  - name: nodecount
    value: 2

pool:
  vmImage: ubuntu-latest

steps:
  - task: AzureCLI@2
    displayName: initial deployment
    inputs:
      azureSubscription: $(azureSubscriptionConnection)
      scriptType: pscore
      scriptLocation: inlineScript
      inlineScript: |
        az group create --name $(rgname) --location $(location)
        az provider register --namespace Microsoft.OperationsManagement
        az provider register --namespace Microsoft.OperationalInsights
        if(-not(az aks show --name $(clustername) --resource-group $(rgname))){
          az aks create --resource-group $(rgname) `
            --name $(clustername) `
            --node-count $(nodecount) `
            --generate-ssh-keys
        }
